type: vertical-stack
cards:
  - type: custom:bubble-card
    card_type: pop-up
    hash: "#strom"
    show_header: false
    bg_color: rgb(43 53 71)
    shadow_opacity: 0
    width_desktop: 650px
    margin_top_desktop: 0vh
  - type: custom:stack-in-card
    card_mod:
      style: |
        ha-card {
          background: none !important;
          border: none !important;
          border-radius: 0px !important;
        }
    cards:
      - type: custom:mini-graph-card
        entities:
          - entity: sensor.growatt_todaygenerateenergy
            name: Ertrag
            show_state: false
          - entity: sensor.energy_production_today_3
            name: Vorhersage
            show_state: false
            color: rgba(122,122,122,0.3)
            y_axis: secondary
        name: Ertrag Heute
        hours_to_show: 72
        points_per_hour: 0.25
        height: 80
        show:
          labels: true
          name: false
          state: false
          icon: false
        color_thresholds:
          - value: 1
            color: grey
          - value: 2
            color: orange
          - value: 3
            color: yellow
          - value: 5
            color: green
          - value: 10
            color: blue
        card_mod:
          style: |
            ha-card {
              margin-top: 1px;
              border: none !important;
              border-radius: 0px !important;
              --line-color: {{ states('sensor.solar_line_color') }};
            }
      - type: custom:button-card
        tap_action:
          action: navigate
          navigation_path: /49686a9f_evcc
        styles:
          card:
            - background-color: rgba(22,22,22, 0.4)
            - text-align: center
            - border: none
            - border-radius: 0px
            - padding: 10px
            - "--primary-text-color": |
                [[[
                  if (states['sensor.solar_color'].state === 'grey') return 'grey';
                  if (states['sensor.solar_color'].state === 'darkyellow') return 'darkyellow';
                  if (states['sensor.solar_color'].state === 'yellow') return 'yellow';
                  if (states['sensor.solar_color'].state === 'darkgreen') return 'darkgreen';
                  return 'green';
                ]]]
        name: |
          [[[
            const solarTotal = states['sensor.growatt_todaygenerateenergy'].state;
            return `Solarertrag heute: ${solarTotal} kWh`;
          ]]]
      - type: entities
        card_mod:
          style: |
            ha-card {
              background: none !important;
              border: none !important;
              border-radius: 0px !important;
            }
        entities:
          - entity: sensor.growatt_todaygenerateenergy_euro
            type: custom:multiple-entity-row
            name: Ertrag Heute €
            state_color: true
            hide_unavailable: true
            entities:
              - entity: sensor.solcast_pv_forecast_prognose_heute
                name: " "
                styles:
                  margin-top: 2px
                  margin-right: 20px
                  text-align: right
                  color: "#676767"
                  font-size: 13px
              - entity: sensor.solcast_pv_forecast_prognose_morgen
                name: " "
                styles:
                  margin-top: 2px
                  margin-right: 20px
                  text-align: right
                  color: "#676767"
                  font-size: 13px
          - entity: sensor.growatt_totalgenerateenergy
            name: Ertrag Gesamt kWh
          - entity: sensor.growatt_totalgenerateenergy_euro
            name: Ertrag Gesamt €
            unit_of_measurement: €
            icon: mdi:counter
          - entity: sensor.solar_netzeinspeisung_kwh
            name: Solar Netzeinspeisung Gesamt
          - entity: sensor.stromverbrauch_gesamt_kwh
            name: Stromverbrauch Gesamt
        theme: grey-icon
      - type: custom:bar-card
        card_mod:
          style: |
            ha-card {
              border: none !important;
              border-radius: 0px !important;
            }               
            bar-card-backgroundbar { 
              border-radius: 3px !important;  
            }
            bar-card-currentbar {
              border-radius: 3px !important;  
            }
        name: Aktueller Strombedarf
        positions:
          name: inside
          value: inside
          indicator: "off"
          icon: "off"
        unit_of_measurement: W
        max: 2500
        height: 25px
        severity:
          - color: "#7bc13c"
            from: 0
            to: 50
          - color: "#c1bb3c"
            from: 50
            to: 340
          - color: orange
            from: 340
            to: 500
          - color: darkorange
            from: 500
            to: 1000
          - color: "#ff0000"
            from: 1000
            to: 50000
        entities:
          - entity: sensor.total_power_nur_verbrauch
      - type: custom:stack-in-card
        card_mod:
          style: |
            ha-card {
              background: none !important;
              border: none !important;
              border-radius: 0px !important;
            }
        cards:
          - type: horizontal-stack
            cards:
              - type: custom:bar-card
                card_mod:
                  style: |
                    ha-card {
                      border: none !important;
                      border-radius: 0px !important;
                      --primary-color: #7bc13c !important;          
                    }
                    #states {
                      padding: 0 16px 0 16px !important;
                    } 
                    bar-card-currentbar {
                      border-radius: 3px !important; 
                        
                      {% if states['switch.acpowervonbatterie'].state == 'on' %}
                      background: linear-gradient(270deg, red, orange, green);
                      background-size: 300% 100%;
                      animation: gradientShiftNormal 3s linear infinite;
                      clip-path: inset(0 calc(100% - var(--bar-percent)) 0 0);

                      {% elif states['switch.acpowerzubatterie'].state == 'on' %}
                      background: linear-gradient(270deg, red, orange, green);
                      background-size: 300% 100%;
                      animation: gradientShiftReverse 3s linear infinite;
                      clip-path: inset(0 calc(100% - var(--bar-percent)) 0 0);

                      {% else %}
                      background: linear-gradient(to right, darkorange 15%, orange 25%, yellow 50%, green 100%);
                      clip-path: inset(0 calc(100% - var(--bar-percent)) 0 0);
                      {% endif %}
                    }                  
                    bar-card-backgroundbar { 
                      border-radius: 3px !important; 
                      background: linear-gradient(to right, darkorange 15%, orange 25%, yellow 50%, green 100%);
                      clip-path: inset(0 calc(100% - var(--bar-percent)) 0 0);
                    }
                    @keyframes gradientShiftNormal {
                      0% { background-position: 0% 50%; }
                      100% { background-position: 100% 50%; }
                    }
                    @keyframes gradientShiftReverse {
                      100% { background-position: 0% 50%; }
                      0% { background-position: 100% 50%; }
                    }
                name: Hausspeicher
                positions:
                  name: inside
                  value: inside
                  indicator: "off"
                  icon: "off"
                unit_of_measurement: "%"
                max: 100
                height: 20px
                severity:
                  - color: "#ff0000"
                    from: 0
                    to: 25
                  - color: darkorange
                    from: 25
                    to: 50
                  - color: orange
                    from: 50
                    to: 75
                  - color: "#7bc13c"
                    from: 75
                    to: 100
                entities:
                  - entity: sensor.batterie_ladezustand
                tap_action:
                  action: navigate
                  navigation_path: "#batterie"
      - type: custom:auto-entities
        card_mod:
          style: |
            ha-card {
              background-color: transparent !important;
              border: none !important;
              border-radius: 0px !important;
            }
        card:
          type: custom:bar-card
          card_mod:
            style: |
              ha-card {
                border: none !important;
                border-radius: 0px !important;
              }               
              bar-card-backgroundbar { 
                border-radius: 3px !important;  
              }
              bar-card-currentbar {
                border-radius: 3px !important;  
              }
          positions:
            name: inside
            value: inside
            indicator: "off"
            icon: "off"
          unit_of_measurement: W
          max: 1000
          severity:
            - color: "#7bc13c"
              from: 0
              to: 50
            - color: "#c1bb3c"
              from: 50
              to: 200
            - color: orange
              from: 200
              to: 500
            - color: darkorange
              from: 500
              to: 1400
            - color: "#ff0000"
              from: 1400
              to: 50000
          height: 20px
          decimals: 2
          style: |
            #states { padding: 0 } 
            bar-card-name, bar-card-value {
              color: #ffffff;
            }
            bar-card-value {
              font-weight: bold;
            }
            bar-card-indicator {
              transform: scaleY(-1);
            }
          stack: vertical
          direction: right
        filter:
          include:
            - entity_id: sensor.innenlufter_shellyplug_switch_0_power
            - entity_id: sensor.growlampe_leistung
            - entity_id: sensor.wasserlauf_leistung
            - entity_id: sensor.stromungspumpen_leistung
            - entity_id: sensor.hauptpumpe_shelly_plug_switch_0_power
            - entity_id: sensor.skimmerpumpe_shelly_plug_switch_0_power
            - entity_id: sensor.poollicht_leistung
            - entity_id: sensor.werkstattheizung_leistung
            - entity_id: sensor.waschmaschine_leistung_2
            - entity_id: sensor.trockner_leistung_3
            - entity_id: sensor.3d_drucker_leistung
            - entity_id: sensor.herdlicht_rechts_leistung
            - entity_id: sensor.herdlicht_links_leistung
            - entity_id: sensor.sockelleisten_leistung
            - entity_id: sensor.weihnachtslicht_leistung
            - entity_id: sensor.lavalampe_leistung
            - entity_id: sensor.computer_leistung
            - entity_id: sensor.fernseher_plug_leistung
            - entity_id: sensor.fernseher_mutti_leistung_3
            - entity_id: sensor.fernseher_plug_mutti_schlafzimmer_leistung
            - entity_id: sensor.tablet_plug_leistung
          exclude:
            - state: < 2
        sort:
          method: state
          numeric: true
          reverse: true
