type: custom:tabbed-card
styles:
  margin-top: 16px !important;
  "--mdc-theme-primary": var(--primary-color)
  "--mdc-tab-text-label-color-default": grey
  "--mdc-typography-button-font-size": 14px
  "--mdc-typography-button-text-transform": capitalize
tabs:
  - card:
      type: vertical-stack
      cards:
        - type: custom:floorplan-card
          grid_options:
            columns: full
          config:
            console_log_level: info
            defaults:
              hover_action: hover-info
              tap_action: more-info
            image: /local/energy-flow-card/energy-flow-card-small.svg
            stylesheet: /local/energy-flow-card/energy-flow-card.css
            rules:
              - element: soc
                entity: sensor.victron_system_battery_soc
                state_action:
                  - service: floorplan.text_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? (Math.round(entity.state * 10) /
                      10).toString().replace(".", ",") + " %" : ""}
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? 'display:block' : 'display:none'}
                  - service: floorplan.class_set
                    service_data:
                      class: static-value
              - element: batterie100
                entity: sensor.victron_system_battery_soc
                state_action:
                  action: call-service
                  service: floorplan.style_set
                  service_data: >
                    ${parseFloat(entity.state) > 97 ? 'display:block' :
                    'display:none'}
              - element: batterie80
                entity: sensor.victron_system_battery_soc
                state_action:
                  action: call-service
                  service: floorplan.style_set
                  service_data: >
                    ${parseFloat(entity.state) > 80 ? 'display:block' :
                    'display:none'}
              - element: batterie60
                entity: sensor.victron_system_battery_soc
                state_action:
                  action: call-service
                  service: floorplan.style_set
                  service_data: >
                    ${parseFloat(entity.state) > 60 ? 'display:block' :
                    'display:none'}
              - element: batterie40
                entity: sensor.victron_system_battery_soc
                state_action:
                  action: call-service
                  service: floorplan.style_set
                  service_data: >
                    ${parseFloat(entity.state) > 40 ? 'display:block' :
                    'display:none'}
              - element: batterie20
                entity: sensor.victron_system_battery_soc
                state_action:
                  action: call-service
                  service: floorplan.style_set
                  service_data: >
                    ${parseFloat(entity.state) > 1 ? 'display:block' :
                    'display:none'}
              - element: dreieckbatteriein
                entity: sensor.batterieladung_vr_watt
                state_action:
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 30) ? 'display:block' : 'display:none'}
              - element: dreieckbatterieout
                entity: sensor.batterieentladung_vr_watt
                state_action:
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0.1) ? 'opacity:1' : 'opacity:0'}
              - element: batteriein
                entity: sensor.victron_system_battery_power
                state_action:
                  - service: floorplan.class_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 30) ? "batteriein" : ""}
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 30) ? "display:block" : "display:none"}
              - element: batterieoutani
                entity: sensor.batterieentladung_vr_watt
                state_action:
                  - service: floorplan.class_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > -10) ? "hausin" : ""}
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 10) ? "display:block" : "display:none"}
              - element: solaroutani
                entities:
                  - sensor.total_solar_power_kombiniert
                  - sensor.total_power_kombiniert
                state_action:
                  - service: floorplan.class_set
                    service_data: |-
                      ${(
                        states['sensor.total_solar_power_kombiniert'].state !== undefined &&
                        states['sensor.total_power_kombiniert'].state !== undefined &&
                        parseFloat(states['sensor.total_solar_power_kombiniert'].state) >= parseFloat(states['sensor.total_power_kombiniert'].state)
                      ) ? "hausin" : ""}
                  - service: floorplan.style_set
                    service_data: |-
                      ${(
                        states['sensor.total_solar_power_kombiniert'].state !== undefined &&
                        states['sensor.total_power_kombiniert'].state !== undefined &&
                        parseFloat(states['sensor.total_solar_power_kombiniert'].state) >= parseFloat(states['sensor.total_power_kombiniert'].state)
                      ) ? "display:block" : "display:none"}
              - element: hausin
                entities:
                  - sensor.total_solar_power_kombiniert
                  - sensor.total_power_kombiniert
                state_action:
                  - service: floorplan.class_set
                    service_data: |-
                      ${(
                        states['sensor.total_power_kombiniert'] &&
                        states['sensor.total_solar_power_kombiniert'] &&
                        parseFloat(states['sensor.total_power_kombiniert'].state) >= parseFloat(states['sensor.total_solar_power_kombiniert'].state)
                      ) ? "hausin" : ""}
                  - service: floorplan.style_set
                    service_data: |-
                      ${(
                        states['sensor.total_power_kombiniert'] &&
                        states['sensor.total_solar_power_kombiniert'] &&
                        parseFloat(states['sensor.total_power_kombiniert'].state) >= parseFloat(states['sensor.total_solar_power_kombiniert'].state)
                      ) ? "display:block" : "display:none"}
              - element: solarin
                entity: sensor.total_solar_power_kombiniert
                state_action:
                  - service: floorplan.class_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 10) ? "solarin" : ""}
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 10) ? "display:block" : "display:none"}
              - element: netzin
                entity: sensor.total_power
                state_action:
                  - service: floorplan.class_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 10) ? "netzin" : ""}
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 10) ? "display:block" : "display:none"}
              - element: netzout
                entity: sensor.total_power
                state_action:
                  - service: floorplan.class_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      < 0) ? "netzout" : ""}
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      < 0) ? "display:block" : "display:none"}
              - element: hausin
                entity: sensor.batterieladung_vr_watt
                state_action:
                  action: call-service
                  service: floorplan.class_set
                  service_data: >-
                    ${(parseFloat(entity.state) > 0) ? 'hausin batteriebetrieb'
                    : 'hausin'}    
              - element: solarleistung
                entity: sensor.erzeugzung_taglich_kombination_solaranlagen
                state_action:
                  - service: floorplan.text_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? (Math.round(entity.state * 10) /
                      10).toString().replace(".", ",") + " kWh" : ""}
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? 'display:block' : 'display:none'}
                  - service: floorplan.class_set
                    service_data:
                      class: static-value
              - element: solarleistungwatt
                entity: sensor.total_solar_power_kombiniert
                state_action:
                  - service: floorplan.text_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? (Math.round(entity.state * 10) /
                      10).toString().replace(".", ",") + " W" : ""}
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? 'display:block' : 'display:none'}
                  - service: floorplan.class_set
                    service_data:
                      class: static-value
              - element: batterie
                entity: sensor.batterieladung_vr_kwh_taglich_2
                state_action:
                  - service: floorplan.text_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0.1) ? (Math.round(entity.state * 10) /
                      10).toString().replace(".", ",") + " kWh" : ""}
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? 'display:block' : 'display:none'}
                  - service: floorplan.class_set
                    service_data:
                      class: static-value
              - element: batterieinwatt
                entity: sensor.batterieladung_vr_watt
                state_action:
                  - service: floorplan.text_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 30) ? (Math.round(entity.state * 10) /
                      10).toString().replace(".", ",") + " W" : ""}
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 30) ? 'display:block' : 'display:none'}
                  - service: floorplan.class_set
                    service_data:
                      class: static-value
              - element: batterieout
                entity: sensor.batterieentladung_vr_kwh_taglich
                state_action:
                  - service: floorplan.text_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0.1) ? (Math.round(entity.state * 10) /
                      10).toString().replace(".", ",") + " kWh" : ""}
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? 'display:block' : 'display:none'}
                  - service: floorplan.class_set
                    service_data:
                      class: static-value
              - element: batterieoutwatt
                entity: sensor.batterieentladung_vr_watt
                state_action:
                  - service: floorplan.text_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? (Math.round(entity.state * 10) /
                      10).toString().replace(".", ",") + " W" : ""}
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? 'display:block' : 'display:none'}
                  - service: floorplan.class_set
                    service_data:
                      class: static-value
              - element: hausverbrauchwatt
                entity: sensor.total_power_kombiniert
                state_action:
                  - service: floorplan.text_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? (Math.round(entity.state * 10) /
                      10).toString().replace(".", ",") + " W" : ""}
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? 'display:block' : 'display:none'}
                  - service: floorplan.class_set
                    service_data:
                      class: static-value
              - element: hausverbrauch
                entity: sensor.verbrauch_taglich_nach_abzug
                state_action:
                  - service: floorplan.text_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? (Math.round(entity.state * 10) /
                      10).toString().replace(".", ",") + " kWh" : ""}
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? 'display:block' : 'display:none'}
                  - service: floorplan.class_set
                    service_data:
                      class: static-value
              - element: netzbezug
                entity: sensor.stromverbrauch_taglich
                state_action:
                  - service: floorplan.text_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? (Math.round(entity.state * 10) /
                      10).toString().replace(".", ",") + " kWh" : ""}
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? 'display:block' : 'display:none'}
                  - service: floorplan.class_set
                    service_data:
                      class: static-value
              - element: netztbezugwatt
                entity: sensor.total_power
                state_action:
                  - service: floorplan.text_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? (Math.round(entity.state * 10) /
                      10).toString().replace(".", ",") + " W" : ""}
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? 'display:block' : 'display:none'}
                  - service: floorplan.class_set
                    service_data:
                      class: static-value
              - element: netzeinspeisung
                entity: sensor.solar_netzeinspeisung_kwh_taglich
                state_action:
                  - service: floorplan.text_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0.06) ? (Math.round(entity.state * 10) /
                      10).toString().replace(".", ",") + " kWh" : ""}
                  - service: floorplan.style_set
                    service_data: >-
                      ${(entity.state !== undefined && parseFloat(entity.state)
                      > 0) ? 'display:block' : 'display:none'}
                  - service: floorplan.class_set
                    service_data:
                      class: static-value
          card_mod:
            style: |
              ha-card {
                border: none;
                box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 4px, rgba(0, 0, 0, 0.3) 0px 7px
                            13px -3px, rgba(0, 0, 0, 0.2) 0px -3px 0px inset !important;            
              }
        - layout: horizontal
          height: 250
          unit_prefix: k
          round: 1
          convert_units_to: ""
          co2_intensity_entity: sensor.co2_signal_co2_intensity
          gas_co2_intensity: 2351.6459999999997
          min_box_size: 5
          min_box_distance: 12
          show_states: true
          show_units: true
          sections:
            - entities:
                - type: entity
                  children:
                    - entity_id: sensor.solar_netzeinspeisung_kwh
                      color: orange
                      name: Netzeinspeisung
                    - entity_id: sensor.batterieentladung_vr_kwh_taglich
                      color: green
                      name: Hausspeicher
                    - entity_id: total
                      color: orange
                  entity_id: sensor.growatt_todaygenerateenergy
                  name: Solar
                  color: green
                - type: entity
                  children:
                    - entity_id: sensor.solar_netzeinspeisung_kwh
                      color: blue
                    - entity_id: total
                      color: red
                  entity_id: sensor.stromverbrauch_gesamt_kwh
                  name: Netzbezug
                  color: orange
            - entities:
                - type: remaining_parent_state
                  children:
                    - entity_id: werkstatt
                      color: cyan
                    - entity_id: garten
                      color: lime
                    - entity_id: wohnzimmer
                      color: pink
                    - entity_id: flur
                      color: magenta
                    - entity_id: unknown
                      color: gray
                  entity_id: total
                  name: Stromverbrauch
                  color: darkorange
                - type: entity
                  children: []
                  entity_id: sensor.solar_netzeinspeisung_kwh
                  name: Netzeinspeisung
                  color: red
                - type: entity
                  entity_id: sensor.batterieentladung_vr_kwh_taglich
                  name: Hausspeicher
                  color: green
            - entities:
                - type: remaining_child_state
                  children:
                    - entity_id: sensor.growlampe_umrechnung_kwh
                      color: brown
                    - entity_id: sensor.werkstattheizung_energiezahler
                      color: brown
                  entity_id: werkstatt
                  name: Werkstatt
                  color: red
                - type: remaining_child_state
                  children:
                    - entity_id: sensor.skimmerpumpe_shelly_plug_switch_0_energy
                      color: lightblue
                    - entity_id: sensor.hauptpumpe_shelly_plug_switch_0_energy
                      color: lightblue
                    - entity_id: sensor.stromungspumpen_umrechnung_kwh
                      color: lightblue
                    - entity_id: sensor.wasserlauf_umrechnung_kwh
                      color: lightblue
                  entity_id: garten
                  name: Garten
                  color: steelblue
                - type: remaining_child_state
                  children:
                    - entity_id: sensor.3d_drucker_summe_verbraucht
                      color: lightcoral
                    - entity_id: sensor.computer_summe_verbraucht
                      color: lightcoral
                    - entity_id: sensor.fernseher_plug_summe_verbraucht
                      color: lightcoral
                  entity_id: wohnzimmer
                  name: Wohnzimmer
                  color: lightcoral
                - type: remaining_child_state
                  children:
                    - entity_id: sensor.trockner_summe_verbraucht_3
                      color: magenta
                    - entity_id: sensor.waschmaschine_summe_verbraucht_2
                      color: magenta
                  entity_id: flur
                  name: HWA
                  color: "#6d006b"
                - type: remaining_parent_state
                  children: []
                  entity_id: unknown
                  name: Unbekannt
                  color: silver
            - entities:
                - type: entity
                  children: []
                  entity_id: sensor.growlampe_umrechnung_kwh
                  name: Growlampe kWh
                  color: brown
                - type: entity
                  children: []
                  entity_id: sensor.werkstattheizung_energiezahler
                  name: Werkstatt Heizung
                  color: brown
                - type: entity
                  children: []
                  entity_id: sensor.skimmerpumpe_shelly_plug_switch_0_energy
                  name: Skimmerpumpe
                  color: lightblue
                - type: entity
                  children: []
                  entity_id: sensor.hauptpumpe_shelly_plug_switch_0_energy
                  name: Hauptpumpe
                  color: lightblue
                - type: entity
                  children: []
                  entity_id: sensor.stromungspumpen_umrechnung_kwh
                  name: Strömungspumpen
                  color: lightblue
                - type: entity
                  children: []
                  entity_id: sensor.wasserlauf_umrechnung_kwh
                  name: Wasserlauf
                  color: lightblue
                - type: entity
                  children: []
                  entity_id: sensor.3d_drucker_summe_verbraucht
                  name: 3D-Drucker
                  color: lightcoral
                - type: entity
                  children: []
                  entity_id: sensor.computer_summe_verbraucht
                  name: Computer
                  color: lightcoral
                - type: entity
                  children: []
                  entity_id: sensor.fernseher_plug_summe_verbraucht
                  name: Fernseher
                  color: lightcoral
                - type: entity
                  children: []
                  entity_id: sensor.trockner_summe_verbraucht_3
                  name: Trockner
                  color: magenta
                - type: entity
                  children: []
                  entity_id: sensor.waschmaschine_summe_verbraucht_2
                  name: Waschmaschine
                  color: magenta
              sort_by: state
              sort_group_by_parent: true
          type: custom:sankey-chart
          min_state: 0
          show_names: true
          show_icons: false
          wide: true
          time_period_from: now/M
          time_period_to: now
          card_mod:
            style: |
              ha-card {    
                box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 4px, rgba(0, 0, 0, 0.3) 0px 7px
                            13px -3px, rgba(0, 0, 0, 0.2) 0px -3px 0px inset !important;
                border: none;
              }
    attributes:
      label: Verbrauch Tag/Monat
      icon: mdi:home-lightning-bolt-outline
  - card:
      type: vertical-stack
      grid_options:
        columns: full
      cards:
        - type: custom:plotly-graph
          defaults:
            yaxes:
              fixedrange: true
              range:
                - 0
                - null
          card_mod:
            style: |
              ha-card {
                box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 4px, rgba(0, 0, 0, 0.3) 0px 7px
                            13px -3px, rgba(0, 0, 0, 0.2) 0px -3px 0px inset !important;
                border: none;
                margin-right: 10px !important;
              }
          entities:
            - entity: sensor.victron_system_battery_soc
              name: SOC
              yaxis: y2
              line:
                width: 3
                shape: spline
                color: rgba(255, 255, 255, 0.3)
              filters:
                - map_y_numbers: Math.min(y, 100)
            - entity: sensor.batterieentladung_vr_watt
              name: Batterieentladung
              yaxis: y1
              fill: tozeroy
              line:
                shape: spline
                color: "#6C9BC4"
              filters:
                - exponential_moving_average:
                    alpha: 0.7
            - entity: sensor.total_solar_power_kombiniert
              name: Solar Kombi
              yaxis: y1
              fill: tozeroy
              line:
                shape: spline
                color: green
              filters:
                - exponential_moving_average:
                    alpha: 0.05
            - entity: sensor.total_power_nur_verbrauch
              name: Netzbezug
              yaxis: y1
              fill: tozeroy
              line:
                shape: spline
                color: orange
              filters:
                - exponential_moving_average:
                    alpha: 0.4
            - entity: sensor.solar_einspeisung_normiert_positiver_wert
              name: Netzeinspeisung
              yaxis: y1
              line:
                shape: spline
                color: red
              filters:
                - exponential_moving_average:
                    alpha: 0.05
            - entity: sensor.batterieladung_vr_watt
              name: Batterieladung
              yaxis: y1
              fill: tozeroy
              line:
                shape: spline
                color: "#AAE1FC"
              filters:
                - exponential_moving_average:
                    alpha: 0.8
            - entity: sensor.power_production_now_3
              name: Vorhersage akt.
              yaxis: y1
              line:
                color: purple
                dash: dot
                width: 2
          hours_to_show: current_day
          refresh_interval: 120
          min_y_axis: 0
          fit_y_data: true
          logarithmic_scale: true
          max_y_axis: 3000
          layout:
            height: 290
            plot_bgcolor: rgba(0,0,0,0)
            margin:
              t: 0
              l: 45
              r: 40
            legend:
              "y": -0.24
              x: 0
        - type: custom:plotly-graph
          defaults:
            yaxes:
              fixedrange: true
            entity:
              period: day
              type: bar
              statistic: state
              texttemplate: "%{y:.1f}"
              textposition: auto
          entities:
            - entity: sensor.erzeugzung_taglich_nach_abzug_einspeisung
              name: Erzeugung
              marker:
                color: green
                opacity: 1
              textfont:
                color: black
              filters:
                - filter: i>0 && i < xs.length - 1
                - fn: |
                    ({ys,xs,hass}) => ({
                      xs: [...xs, new Date().setHours(0,0,0)],
                      ys: [...ys, hass.states['sensor.erzeugzung_taglich_nach_abzug_einspeisung'].state],
                    })
            - entity: sensor.batterieentladung_vr_kwh_taglich
              name: Akku Entladung
              marker:
                color: "#6C9BC4"
                opacity: 1
              textfont:
                color: black
              filters:
                - filter: i>0 && i < xs.length - 1
                - fn: |
                    ({ys,xs,hass}) => ({
                      xs: [...xs, new Date().setHours(0,0,0)],
                      ys: [...ys, hass.states['sensor.batterieentladung_vr_kwh_taglich'].state],
                    })
            - entity: sensor.stromverbrauch_taglich
              name: Bezug
              marker:
                color: darkorange
                opacity: 1
              textfont:
                color: purple
              filters:
                - filter: i>0 && i < xs.length - 1
                - fn: |
                    ({ys,xs,hass}) => ({
                      xs: [...xs, new Date().setHours(0,0,0)],
                      ys: [...ys, hass.states['sensor.stromverbrauch_taglich'].state],
                    })
            - entity: sensor.verbrauch_taglich_nach_abzug
              name: Verbrauch
              marker:
                color: "#CAD97D"
                opacity: 0.4
              filters:
                - filter: i>0 && i < xs.length - 1
                - fn: |
                    ({ys,xs,hass}) => ({
                      xs: [...xs, new Date().setHours(6,0,0)],
                      ys: [...ys, hass.states['sensor.verbrauch_taglich_nach_abzug'].state],
                    })
              time_offset: 6h
            - entity: sensor.batterieladung_vr_kwh_taglich_2
              name: Akku Beladung
              marker:
                color: "#AAE1FC"
                opacity: 0.4
              filters:
                - filter: i>0 && i < xs.length - 1
                - fn: |
                    ({ys,xs,hass}) => ({
                      xs: [...xs, new Date().setHours(6,0,0)],
                      ys: [...ys, hass.states['sensor.batterieladung_vr_kwh_taglich_2'].state],
                    })
              time_offset: 6h
            - entity: sensor.solar_netzeinspeisung_kwh_taglich
              name: Netzeinspeisung
              marker:
                color: red
                opacity: 0.4
              textfont:
                color: grey
              filters:
                - filter: i>0 && i < xs.length - 1
                - fn: |
                    ({ys,xs,hass}) => ({
                      xs: [...xs, new Date().setHours(6,0,0)],
                      ys: [...ys, hass.states['sensor.solar_netzeinspeisung_kwh_taglich'].state],
                    })
              time_offset: 6h
            - entity: sensor.energy_production_today_3
              name: Prognose
              marker:
                color: "#45664a"
                opacity: 0.2
              textfont:
                color: white
              filters:
                - filter: i>0 && i < xs.length - 1
                - fn: |
                    ({ys,xs,hass}) => ({
                      xs: [...xs, new Date().setHours(-6,0,0)],
                      ys: [...ys, hass.states['sensor.energy_production_today_3'].state],
                    })
              time_offset: "-6h"
          layout:
            plot_bgcolor: rgba(0,0,0,0)
            barmode: stack
            bargap: 0.05
            barcornerradius: 2
            uniformtext:
              minsize: 10
              mode: show
            modebar:
              orientation: v
              remove: zoom
            margin:
              t: 5
              l: 45
              r: 20
            height: 380
            legend:
              "y": -0.22
              x: 0.1
            xaxis:
              rangeselector:
                "y": 1.05
                buttons:
                  - count: 1
                    step: day
                  - count: 7
                    step: day
                  - count: 10
                    step: day
                  - count: 30
                    step: day
                  - count: 6
                    step: month
              gridcolor: rgba(238,235,235,0.3)
              autorange: true
              showgrid: true
            yaxis:
              visible: true
              autorange: true
          hours_to_show: 7d
          refresh_interval: 360
          card_mod:
            style: |
              ha-card {
                box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 4px, rgba(0, 0, 0, 0.3) 0px 7px
                            13px -3px, rgba(0, 0, 0, 0.2) 0px -3px 0px inset !important;
                border: none;   
                margin-top: 3px;
                margin-bottom: 0px;
              }
    attributes:
      label: Aufteilung Heute
      icon: mdi:solar-power
  - card:
      type: custom:layout-card
      layout_type: custom:grid-layout
      layout:
        grid-template-columns: 55% 45%
        grid-template-rows: auto
        mediaquery:
          "(max-width: 1000px)":
            grid-template-columns: 100%
            grid-template-rows: auto
      cards:
        - type: custom:power-flow-card-plus
          entities:
            battery:
              entity:
                consumption: sensor.batterieentladung_vr_watt
                production: sensor.batterieladung_vr_watt
              state_of_charge: sensor.victron_system_battery_soc
              state_of_charge_unit_white_space: false
              show_state_of_charge: true
              color_state_of_charge_value: true
            solar:
              entity: sensor.total_solar_power_kombiniert
              display_zero_state: true
              secondary_info: {}
              color_value: true
              color_icon: false
              invert_state: false
              use_metadata: false
              color:
                - 11
                - 157
                - 67
            individual:
              - entity: sensor.poolverbrauch_summe_watt
                secondary_info: {}
                icon: mdi:pool
                name: Pool Summe
                color:
                  - 42
                  - 101
                  - 156
              - entity: sensor.growlampe_leistung
                secondary_info: {}
                name: GrowLed
                calculate_flow_rate: false
                color_value: false
                color_icon: false
                icon: mdi:ceiling-light
                unit_white_space: true
                inverted_animation: false
                show_direction: false
                use_metadata: false
              - entity: sensor.innenlufter_shellyplug_switch_0_power
                secondary_info: {}
                name: Lüfter
                icon: mdi:fan
                color:
                  - 115
                  - 156
                  - 217
              - entity: sensor.werkstattheizung_leistung
                secondary_info: {}
                color:
                  - 98
                  - 9
                  - 9
                display_zero: false
                name: Werkstatt Hzg.
                display_zero_state: false
                color_value: false
                color_icon: false
                icon: mdi:heating-coil
                use_metadata: false
                show_direction: false
            home:
              secondary_info: {}
              circle_animation: true
              override_state: true
              subtract_individual: true
              color_icon: true
              color_value: true
            grid:
              secondary_info: {}
              icon: ""
              color:
                consumption:
                  - 211
                  - 102
                  - 13
                production:
                  - 182
                  - 12
                  - 12
              color_value: true
              invert_state: false
              entity:
                consumption: sensor.total_power_nur_verbrauch
                production: sensor.solar_einspeisung_normiert_positiver_wert
              color_circle: true
              color_icon: true
          clickable_entities: true
          display_zero_lines:
            mode: transparency
            transparency: 50
            grey_color:
              - 189
              - 189
              - 189
          use_new_flow_rate_model: true
          w_decimals: 0
          kw_decimals: 1
          min_flow_rate: 0.75
          max_flow_rate: 6
          max_expected_power: 3000
          min_expected_power: 0.01
          watt_threshold: 1000
          transparency_zero_lines: 0
          card_mod:
            style: |
              ha-card {
                border: none;
                box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 4px, rgba(0, 0, 0, 0.3) 0px 7px
                            13px -3px, rgba(0, 0, 0, 0.2) 0px -3px 0px inset !important;            
              }
        - type: custom:power-flow-card-plus
          entities:
            solar:
              display_zero_state: true
              secondary_info: {}
              color_value: true
              color_icon: false
              invert_state: false
              use_metadata: false
              color:
                - 11
                - 157
                - 67
            individual:
              - entity: sensor.wasserlauf_leistung
                secondary_info: {}
                icon: mdi:chart-waterfall
                name: Wasserlauf
                color:
                  - 42
                  - 101
                  - 156
              - entity: sensor.stromungspumpen_leistung
                secondary_info: {}
                name: Strömungspumpen
                calculate_flow_rate: false
                color_value: false
                color_icon: true
                icon: mdi:air-filter
                unit_white_space: true
                inverted_animation: false
                show_direction: false
                use_metadata: false
              - entity: sensor.skimmerpumpe_shelly_plug_switch_0_power
                secondary_info: {}
                name: Skimmer
                icon: mdi:waves-arrow-right
                color:
                  - 47
                  - 90
                  - 156
              - entity: sensor.poollicht_leistung
                secondary_info: {}
                color:
                  - 239
                  - 200
                  - 6
                display_zero: false
                name: Poollicht
                display_zero_state: false
                color_value: false
                color_icon: false
                icon: mdi:light-flood-down
                use_metadata: false
                show_direction: false
            home:
              secondary_info:
                icon: ""
                color_value: false
              circle_animation: false
              override_state: true
              subtract_individual: false
              color_icon: battery
              icon: mdi:waves-arrow-left
              entity: sensor.hauptpumpe_shelly_plug_switch_0_power
              name: Hauptpumpe
              use_metadata: false
            grid:
              secondary_info: {}
              icon: ""
              color:
                consumption:
                  - 211
                  - 102
                  - 13
                production:
                  - 182
                  - 12
                  - 12
              color_value: true
              invert_state: false
              entity: sensor.poolverbrauch_summe_watt
              use_metadata: false
              display_state: one_way_no_zero
              color_icon: true
              color_circle: true
            clickable_entities: true
            display_zero_lines:
              mode: transparency
              transparency: 50
              grey_color:
                - 189
                - 189
                - 189
            use_new_flow_rate_model: true
            w_decimals: 0
            kw_decimals: 1
            min_flow_rate: 0.75
            max_flow_rate: 6
            max_expected_power: 3000
            min_expected_power: 0.01
            watt_threshold: 1000
            transparency_zero_lines: 0
          card_mod:
            style: |
              ha-card {
                border: none;
                box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 4px, rgba(0, 0, 0, 0.3) 0px 7px
                            13px -3px, rgba(0, 0, 0, 0.2) 0px -3px 0px inset !important;            
              }
        - type: custom:plotly-graph
          defaults:
            yaxes:
              fixedrange: true
              range:
                - 0
                - null
          card_mod:
            style: |
              ha-card {
                box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 4px, rgba(0, 0, 0, 0.3) 0px 7px
                            13px -3px, rgba(0, 0, 0, 0.2) 0px -3px 0px inset !important;
                border: none;
                margin-right: 10px !important;
              }
          entities:
            - entity: sensor.total_solar_power_kombiniert
              name: Gesamt
              yaxis: y1
              line:
                color: steelblue
                width: 2
            - entity: sensor.growatt_outpowerwatt
              name: PV Dach
              yaxis: y1
              fill: tozeroy
              line:
                shape: spline
                color: green
              filters:
                - exponential_moving_average:
                    alpha: 0.05
            - entity: sensor.opendtu_a8067c_ac_power
              name: BKW S/O
              yaxis: y1
              fill: tozeroy
              line:
                shape: spline
                color: orange
              filters:
                - exponential_moving_average:
                    alpha: 0.05
            - entity: sensor.batterie_neo800_total_ausgangsleistung
              name: BKW Pool
              yaxis: y1
              fill: tozeroy
              line:
                shape: spline
                color: yellow
              filters:
                - exponential_moving_average:
                    alpha: 0.05
            - entity: sensor.stream_mikro_wechselrichter_1180_power_ac
              name: BKW Nord
              yaxis: y1
              fill: tozeroy
              line:
                shape: spline
                color: purple
              filters:
                - exponential_moving_average:
                    alpha: 0.05
          hours_to_show: 7
          refresh_interval: 120
          min_y_axis: 0
          fit_y_data: true
          logarithmic_scale: true
          max_y_axis: 3000
          layout:
            plot_bgcolor: rgba(0,0,0,0)
            margin:
              t: 0
              l: 45
              r: 40
            legend:
              "y": -0.24
              x: 0
        - type: custom:power-flow-card-plus
          entities:
            individual:
              - entity: sensor.opendtu_a8067c_ac_power
                secondary_info: {}
                name: BKW Süd Ost
                calculate_flow_rate: true
                color_value: false
                color: orange
                icon: mdi:solar-panel
                unit_white_space: true
                inverted_animation: false
                show_direction: false
                use_metadata: false
              - entity: sensor.batterie_neo800_total_ausgangsleistung
                secondary_info: {}
                name: BKW Pool
                icon: mdi:solar-panel
                color: yellow
              - entity: sensor.stream_mikro_wechselrichter_1180_power_ac
                secondary_info: {}
                icon: mdi:solar-panel
                name: BKW Nord
                color: purple
            home:
              secondary_info:
                icon: ""
                color_value: false
              circle_animation: true
              override_state: true
              subtract_individual: false
              color_icon: true
              icon: mdi:solar-panel-large
              entity: sensor.growatt_outpowerwatt
              name: Solar Dach
              use_metadata: false
            grid:
              secondary_info: {}
              icon: mdi:solar-power
              name: Solar In
              color:
                consumption: green
                production:
                  - 182
                  - 12
                  - 12
              color_value: true
              invert_state: false
              entity: sensor.total_solar_power_kombiniert
              use_metadata: false
              display_state: one_way_no_zero
              color_icon: true
              color_circle: true
            clickable_entities: true
            display_zero_lines:
              mode: transparency
              transparency: 50
              grey_color:
                - 189
                - 189
                - 189
            use_new_flow_rate_model: true
            w_decimals: 1
            kw_decimals: 0
            min_flow_rate: 0.75
            max_flow_rate: 6
            max_expected_power: 3000
            min_expected_power: 0.01
            watt_threshold: 500
            transparency_zero_lines: 0
          card_mod:
            style: |
              ha-card {
                border: none;
                box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 4px, rgba(0, 0, 0, 0.3) 0px 7px
                            13px -3px, rgba(0, 0, 0, 0.2) 0px -3px 0px inset !important;            
              }
    attributes:
      label: Leistung Akt.
      icon: mdi:solar-power-variant
  - card:
      type: vertical-stack
      cards:
        - type: custom:stack-in-card
          card_mod:
            style: |
              ha-card {
                padding: 0px;
                border: none;
                box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 4px, rgba(0, 0, 0, 0.3) 0px 7px
                            13px -3px, rgba(0, 0, 0, 0.2) 0px -3px 0px inset !important;            
              }
          cards:
            - type: horizontal-stack
              cards:
                - type: energy-date-selection
                  card_mod:
                    style: |
                      ha-card {
                        border: 0px;
                        background: transparent !important;                        
                      }
            - type: custom:layout-card
              layout_type: custom:grid-layout
              layout:
                grid-template-columns: 70% 30%
                grid-template-rows: auto
                mediaquery:
                  "(max-width: 1000px)":
                    grid-template-columns: 100%
                    grid-template-rows: auto
              cards:
                - type: vertical-stack
                  cards:
                    - type: energy-usage-graph
                      card_mod:
                        style: |
                          ha-card  {
                            margin-top: -20px;
                            background: transparent !important;
                          }
                    - type: energy-solar-graph
                      card_mod:
                        style: |
                          ha-card  {
                            margin-top: -20px;
                            background: transparent !important;
                          }
                - type: vertical-stack
                  cards:
                    - type: energy-distribution
                      card_mod:
                        style: |
                          ha-card {
                            margin-top: -20px;
                            background: transparent !important;
                          }
                    - type: custom:venus-os-dashboard
                      param:
                        boxCol1: 2
                        boxCol3: 2
                        boxCol2: 1
                      theme: dark
                      devices:
                        1-1:
                          icon: mdi:transmission-tower
                          name: Netz
                          entity: sensor.total_power
                          anchors: R-1
                          link:
                            "1":
                              start: R-1
                              end: 2-1_L-1
                              entity: sensor.total_power
                          graph: true
                        1-2:
                          icon: mdi:battery-charging
                          name: Batterie
                          entity: sensor.victron_system_battery_soc
                          anchors: R-1
                          link:
                            "1":
                              start: R-1
                              end: 2-1_B-1
                              entity: sensor.victron_system_battery_power
                          gauge: true
                          graph: true
                        2-1:
                          icon: mdi:cellphone-charging
                          name: Multiplus II
                          entity: sensor.victron_system_battery_state
                          anchors: L-1, B-2, R-1
                        3-1:
                          icon: mdi:home-lightning-bolt
                          name: AC-Haus
                          entity: sensor.total_power_kombiniert
                          anchors: L-1
                          link:
                            "1":
                              start: L-1
                              end: 2-1_R-1
                              entity: sensor.total_power_kombiniert
                              inv: true
                        3-2:
                          icon: mdi:weather-sunny
                          name: Solar
                          entity: sensor.total_solar_power_kombiniert
                          anchors: L-1
                          link:
                            "1":
                              start: L-1
                              end: 2-1_B-2
                              entity: sensor.total_solar_power_kombiniert
                              inv: true
                          graph: true
                      styles:
                        header: auto
                        footer: auto
                      grid_options:
                        columns: full
                      card_mod:
                        style: |
                          ha-card {
                            box-shadow: nonoe !important;
                            background-color: transparent;
                          --box-background-color: rgb(31,42,60,0.1);
                          --box-shadow-color: #38619b;
                          --anchor-color: green;
                          --line-color: orange;
                          }
                          .dashboard {
                            background: none;
                          }
                          .boxSensor1 {
                            padding-top: 5px !important;
                          }
                          .ball {
                            r: 6 !important;
                            fill: steelblue !important; 
                          }
                          .graph path {
                            stroke: green !important;
                          }
                          .boxFooter {
                            position: absolute;
                            display: flex;
                            flex-direction: column;
                            flex-wrap: wrap;
                            bottom: 2px;
                            width: 100%;
                            font-size: 0.8em;
                            gap: 10% !important;
                            z-index: 1000;
                          }
                          .headerEntity {
                            font-size: 0.8em;
                            line-height: 1.1em;
                          }
    attributes:
      label: History Strom
      icon: mdi:history
  - card:
      type: vertical-stack
      cards:
        - type: custom:stack-in-card
          card_mod:
            style: |
              ha-card {
                padding: 0px;
                border: none;
                box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 4px, rgba(0, 0, 0, 0.3) 0px 7px
                            13px -3px, rgba(0, 0, 0, 0.2) 0px -3px 0px inset !important;            
              }
          cards:
            - type: horizontal-stack
              cards:
                - type: energy-date-selection
                  card_mod:
                    style: |
                      ha-card {
                        border: 0px;
                        background: transparent !important;                        
                      }
            - type: custom:layout-card
              layout_type: custom:grid-layout
              layout:
                grid-template-columns: 70% 30%
                grid-template-rows: auto
                mediaquery:
                  "(max-width: 1000px)":
                    grid-template-columns: 100%
                    grid-template-rows: auto
              cards:
                - type: horizontal-stack
                  cards:
                    - type: energy-devices-graph
                      card_mod:
                        style: |
                          ha-card {
                            margin-top: -20px;
                            background: transparent !important;
                          }
                - type: vertical-stack
                  cards:
                    - type: energy-grid-neutrality-gauge
                      card_mod:
                        style: |
                          ha-card {
                            margin-top: -20px;
                            background: transparent !important;
                          }
                          ha-svg-icon {
                            visibility: hidden; 
                          }
                    - type: energy-distribution
                      card_mod:
                        style: |
                          ha-card {
                            margin-top: -20px;
                            background: transparent !important;
                          }
    attributes:
      label: History Geräte
      icon: mdi:history
grid_options:
  columns: full
