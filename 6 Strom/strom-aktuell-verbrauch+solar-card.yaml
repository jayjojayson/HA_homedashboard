type: custom:vertical-stack-in-card
card_mod:
  style: |
    ha-card {
      box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 4px, rgba(0, 0, 0, 0.3) 0px 7px
                  13px -3px, rgba(0, 0, 0, 0.2) 0px -3px 0px inset !important;
      border: none;   
      background: none;
    }
cards:
  - type: custom:stack-in-card
    cards:
      - type: horizontal-stack
        card_mod:
          style: |
            :host {
              background-color: transparent !important;
              border: none !important;
            }
        cards:
          - type: energy-self-sufficiency-gauge
            card_mod:
              style: |
                ha-card {
                  width: 80% !important;
                  margin: 0 auto;
                  background-color: transparent !important;
                  border: 0px !important;
                  border-radius: 0px !important;
                  --line-color: {{ states('sensor.solar_line_color') }};
                }
                ha-svg-icon {
                  visibility: hidden; 
                }
          - type: energy-solar-consumed-gauge
            card_mod:
              style: |
                ha-card {
                  width: 80% !important;
                  margin: 0 auto;
                  background-color: transparent !important;
                  border: none !important;
                  border-radius: 0px !important;
                  --line-color: {{ states('sensor.solar_line_color') }};
                }
                ha-svg-icon {
                  visibility: hidden; 
                }
  - type: custom:mini-graph-card
    entities:
      - entity: sensor.erzeugzung_taglich_kombination_solaranlagen
        name: Ertrag
        show_state: false
    name: Ertrag Heute
    hours_to_show: 72
    points_per_hour: 0.25
    height: 80
    show:
      labels: true
      name: false
      state: false
      icon: false
    color_thresholds:
      - value: 1
        color: grey
      - value: 2
        color: orange
      - value: 6
        color: yellow
      - value: 10
        color: green
      - value: 14
        color: blue
    card_mod:
      style: |
        ha-card {
          margin-top: 1px;
          border: none !important;
          border-radius: 0px !important;
          --line-color: {{ states('sensor.solar_line_color') }};
        }
  - type: custom:button-card
    styles:
      card:
        - background-color: rgba(22,22,22, 0.4)
        - text-align: center
        - border: none
        - border-radius: 0px
        - padding: 10px
        - "--primary-text-color": |
            [[[
              if (states['sensor.solar_color'].state === 'grey') return 'grey';
              if (states['sensor.solar_color'].state === 'darkyellow') return 'darkyellow';
              if (states['sensor.solar_color'].state === 'yellow') return 'yellow';
              if (states['sensor.solar_color'].state === 'darkgreen') return 'darkgreen';
              return 'green';
            ]]]
    name: |
      [[[
        const solarTotal = states['sensor.erzeugzung_taglich_kombination_solaranlagen'].state;
        return `Solarertrag heute: ${solarTotal} kWh`;
      ]]]
  - type: entities
    entities:
      - entity: sensor.growatt_todaygenerateenergy_euro
        type: custom:multiple-entity-row
        name: Ertrag Heute €
        state_color: true
        hide_unavailable: true
        entities:
          - entity: sensor.energy_production_today_3
            name: " "
            styles:
              margin-top: 2px
              margin-right: 20px
              text-align: right
              color: "#676767"
              font-size: 13px
          - entity: sensor.energy_production_tomorrow_3
            name: " "
            styles:
              margin-top: 2px
              margin-right: 20px
              text-align: right
              color: "#676767"
              font-size: 13px
      - entity: sensor.growatt_totalgenerateenergy
        name: Ertrag Gesamt kWh
      - entity: sensor.growatt_totalgenerateenergy_euro
        name: Ertrag Gesamt €
        unit_of_measurement: €
        icon: mdi:counter
      - entity: sensor.solar_netzeinspeisung_kwh
        name: Solar Netzeinspeisung Gesamt
      - entity: sensor.stromverbrauch_gesamt_kwh
        name: Stromverbrauch Gesamt
    theme: grey-icon
  - type: custom:bar-card
    card_mod:
      style: |
        ha-card {
          border: none !important;
          border-radius: 0px !important;
        }               
        bar-card-backgroundbar { 
          border-radius: 3px !important;  
        }
        bar-card-currentbar {
          border-radius: 3px !important;  
        }
    name: Aktueller Strombedarf
    positions:
      name: inside
      value: inside
      indicator: "off"
      icon: "off"
    unit_of_measurement: W
    max: 2500
    height: 25px
    severity:
      - color: "#7bc13c"
        from: 0
        to: 50
      - color: "#c1bb3c"
        from: 50
        to: 340
      - color: orange
        from: 340
        to: 500
      - color: darkorange
        from: 500
        to: 1000
      - color: "#ff0000"
        from: 1000
        to: 50000
    entities:
      - entity: sensor.total_power_nur_verbrauch
  - type: custom:stack-in-card
    cards:
      - type: horizontal-stack
        cards:
          - type: custom:bubble-card
            name: Hausspeicher
            card_type: button
            button_type: state
            entity: sensor.victron_system_battery_soc
            tap_action:
              action: navigate
              navigation_path: "#batterie"
            modules:
              - progress_bar
            progress_bar:
              progress_color: red
              min_value: 0
              max_value: 100
              conditional_colors:
                condition_color_1: orange
                condition_color_2: green
                condition_1:
                  - condition: numeric_state
                    entity_id: sensor.victron_system_battery_soc
                    below: 55
                condition_2:
                  - condition: numeric_state
                    entity_id: sensor.victron_system_battery_soc
                    above: 55
            sub_button:
              - entity: sensor.batterie_vr_endladezeit
                show_icon: false
                show_name: false
                show_state: true
                state_background: false
                show_background: false
              - entity: sensor.victron_system_battery_power
                show_state: true
                show_icon: false
                state_background: false
                show_background: false
                name: ""
                show_name: true
              - entity: sensor.victron_system_battery_voltage
                show_icon: false
                show_name: false
                show_state: true
                state_background: false
                show_background: false
            styles: |
              .bubble-button-card-container {
                background: linear-gradient(to right, darkorange 15%, orange 25%, yellow 50%, green 100%);
                /* opacity: 0.5 !important; */
                clip-path: inset(0 calc(100% - var(--bar-percent)) 0 0);
                border-radius: 10px !important;   
                border-radius: 3px !important;    
              }
              .bubble-name-container { 
                color: #3a3a3a !important;
              }
              .bubble-sub-button-name-container { 
                color: #3a3a3a !important;
              }
              .bubble-action-enabled { 
                border-radius: 3px !important;
                margin: 0 5px 0 0 !important;
              }
              .bubble-button-background { 
                /* background: linear-gradient(to right, var(--orange-color), #cd101000); */
              }
              .bubble-state {
                font-size: 14px;
                font-weight: bold;
                opacity: 1;
              }
              .bubble-icon {
                color: #3a3a3a !important;
              }
              .type-custom-bubble-card{
                margin: 0px 16px 0px 16px !important;
              }
            rows: "0.75"
  - type: custom:auto-entities
    card_mod:
      style: |
        ha-card {
          background-color: transparent !important;
          border: none !important;
          border-radius: 0px !important;
        }
    card:
      type: custom:bar-card
      card_mod:
        style: |
          ha-card {
            border: none !important;
            border-radius: 0px !important;
          }               
          bar-card-backgroundbar { 
            border-radius: 3px !important;  
          }
          bar-card-currentbar {
            border-radius: 3px !important;  
          }
      positions:
        name: inside
        value: inside
        indicator: "off"
        icon: "off"
      unit_of_measurement: W
      max: 1000
      severity:
        - color: "#7bc13c"
          from: 0
          to: 65
        - color: "#c1bb3c"
          from: 65
          to: 200
        - color: orange
          from: 200
          to: 500
        - color: darkorange
          from: 500
          to: 1400
        - color: "#ff0000"
          from: 1400
          to: 50000
      height: 20px
      decimals: 2
      style: |
        #states { padding: 0 } 
        bar-card-name, bar-card-value {
          color: #ffffff;
        }
        bar-card-value {
          font-weight: bold;
        }
        bar-card-indicator {
          transform: scaleY(-1);
        }
      stack: vertical
      direction: right
    filter:
      include:
        - entity_id: sensor.innenlufter_shellyplug_switch_0_power
        - entity_id: sensor.growlampe_leistung
        - entity_id: sensor.wasserlauf_leistung
        - entity_id: sensor.stromungspumpen_leistung
        - entity_id: sensor.hauptpumpe_shelly_plug_switch_0_power
        - entity_id: sensor.skimmerpumpe_shelly_plug_switch_0_power
        - entity_id: sensor.poollicht_leistung
        - entity_id: sensor.werkstattheizung_leistung
        - entity_id: sensor.waschmaschine_leistung_2
        - entity_id: sensor.trockner_leistung_3
        - entity_id: sensor.3d_drucker_leistung
        - entity_id: sensor.herdlicht_rechts_leistung
        - entity_id: sensor.herdlicht_links_leistung
        - entity_id: sensor.sockelleisten_leistung
        - entity_id: sensor.weihnachtslicht_leistung
        - entity_id: sensor.lavalampe_leistung
        - entity_id: sensor.computer_leistung
        - entity_id: sensor.fernseher_plug_leistung
        - entity_id: sensor.fernseher_mutti_leistung_3
        - entity_id: sensor.fernseher_plug_mutti_schlafzimmer_leistung
        - entity_id: sensor.tablet_plug_leistung
      exclude:
        - state: < 2
        - state: unavailable
    sort:
      method: state
      numeric: true
      reverse: true
